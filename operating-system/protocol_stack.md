### 프로토콜 스택
- OS 내부에 존재
- 액세스 대상의 웹 서버에 메시지를 송신하는 역할
- 브라우저뿐 아니라 모든 네트워크 애플리케이션에서도 사용

<br>

### 데이터 송수신 동작 과정
> 데이터 송수신 동작을 하기 위해서는 서버과 클라이언트 사이를 파이프로 연결해야함  
> 소켓: 파이프 양 끝의 데이터 출입구

1. 소켓 생성
2. 서버측의 소켓에 파이프 연결
3. 데이터 송수신
4. 파이프 분리 후 소켓 말소

<br>

> 위 동작을 실행시키는 주체: OS 내부의 프로토콜 스택  
> 위 동작이 실행되는 주체: Socket 라이브러리 내부의 프로그램 부품

<br>

#### Socket 라이브러리 호출 순서
대략적인 호출의 순서는 아래와 같다.

```text
<메모리 영역> = gethostbyname("url");
<디스크립터> = socket(<IPv4사용>, <스트림형>, ...);         // 소켓 생성
connect(<디스크립터>, <서버IP주소+포트번호>, ...);          // 연결
write(<디스크립터>, <송신 데이터>, <송신 데이터 길이>);      // 송신
<수신 데이터 길이> = read(<디스크립터>, <수신 버퍼>, ...);   // 수신
close(<디스크립터>);
```

> 디스크립터: 소켓을 식별하기 위해 사용

<br>

#### 2. 파이프 연결하는 과정

**connect를 호출할 때 필요한 것**

- 디스크립터
  - 최초의 디스크립터: 소켓 생성 시 반환된 디스크립터
  - 해당 디스크립터를 connect가 프로토콜 스택에 통지
  - 프로토콜 스택은 통지받은 디스크립터로 소켓 식별해 접속 동작 실행
  - 컴퓨터 한 대의 내부에서 소켓을 식별하기 위해 사용
- 서버의 IP 주소
  - DNS 서버에 조회해 조사한 액세스 대상 서버의 IP 주소
  - 송수신하는 상대의 IP 주소
  - 네트워크의 어느 컴퓨터에 접근해야하는가 판별 가능 (소켓까지는 판별 X)
- 서버의 포트 번호
  - 소켓 판별 가능하게 도와줌
  - 접속을 시도하는 측(클라이언트)에서 (서버측) 소켓을 식별하기 위한 중간 과정에 사용

<br>

> **포트 번호**  
> URL에 포트 번호가 생략되는 경우가 많다.  
> 세계적으로 통일된 포트 번호 규칙이 있기 때문이다.  
> (ex: 80번은 웹, 25번은 메일, ...)  
> IP 주소같이 다른 것과 중복되지 않도록 IANA라는 기관이 관리한다.

<br>

**정리**

- 디스크립터: 애플리케이션이 소켓을 식별하는 것
- IP 주소 + 포트번호: 클라이언트 - 서버 간에 상대의 소켓을 식별하는 것

<br>

**서버는 클라이언트의 포트 번호를 어떻게 아는가?**

1. 클라이언트 쪽 소켓의 포트 번호: 소켓 생성 시 프로토콜 스택이 적당한 값을 골라서 할당
2. 접속 동작을 실행할 때 1을 서버에 통지

<br>

#### 3. 데이터 송수신

**데이터 송신**  

1. 애플리케이션은 송신 데이터(Http Request Message)를 메모리에 준비
2. write 호출 시 디스크립터와 1 지정
3. 프로토콜 스택이 1을 서버에게 송신
  - 소켓에는 연결된 상대가 기록되어 있어 디스크립터로 소켓을 지정하면 연결된 상대 판명 가능
4. 네트워크를 통해 서버에 1 도착
5. 서버가 수신 동작을 실행해 1의 내용을 조사하고 적절한 처리
6. 서버가 응답 메시지 반송

**데이터 수신**
1. Socket 라이브러리의 read를 통해 프로토콜 스택에 수신 동작 의뢰
  - 이때 응답 메시지를 저장하기 위한 메모리 영역 지정
  - 이 메모리 영역을 수신 버퍼라고 부름
2. 응답 메시지가 도착하면 수신 버퍼에 저장
  - 수신 버퍼: 애플리케이션 프로그램 내부에 마련된 메모리 영역
  - 수신 버퍼에 메시지를 저장 -> 메시지를 애플리케이션에 건냄

<br>

#### 4. 연결 끊기

1. 브라우저의 데이터 수신이 완료되면 송수신 동작 종료
2. 서버에서 Socket 라이브러리의 close 호출
  - 소켓 사이에 연결된 파이프 분리 + 소켓 말소
3. 클라이언트 측에 전달됨
4. 소켓 연결 끊기 단계 시작

> close는 주로 서버가 먼저 하지만 클라이언트에서 먼저 하는 경우도 있다.  
> 어느 쪽에서 close 하던간에 연결은 무사히 끊긴다.
