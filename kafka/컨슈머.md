# 컨슈머; Consumer

- 카프카에 저장된 메시지를 꺼내오는 역할


## 오프셋 관리

- `오프셋`: 메시지를 나타내는 위치
- `__consumer_offsets`: 컨슈머 그룹이 읽은 오프셋을 저장하는 토픽. (읽은 위치가 아닌 다음으로 읽어야 할 위치를 저장)

### 그룹 코디네이터

- 컨슈머 그룹
  - 여러개의 컨슈머로 구성
  - 컨슈머는 그룹에서 들어오고 나가는 것이 자유로움
  - 그룹 내의 변화를 인지하며 각 컨슈머들에게 작업을 균등하게 분배해야 함 (= 컨슈머 리밸런싱)
    - 경우에 따라 높은 비용이 지출되므로 자주 발생하지 않도록 해야함
    - 컨슈머를 재시작하면 전체 리밸런싱이 일어남
- 그룹 코디네이터
  - : 안정적인 컨슈머 그룹 관리를 하기 위한 코디네이터
  - 컨슈머 그룹이 구독한 토픽의 타피션들과 그룹의 멤버들 트래킹 목적
  - 컨슈머 그룹이 브로커에 최초 연결을 요청하면 브로커 중 하나에 생성됨

<img width="630" alt="image" src="https://github.com/yeon-06/memo/assets/53105735/c67a997d-0cfe-440b-9291-c53556f7cac0">

1. 컨슈머 -> 브로커: 컨슈머 클라이언트와 초기 커넥션을 연결하기 위한 요청 전송
2. 브로커: 그룹 코디네이터 생성 및 컨슈머에게 응답
3. 그룹 코디네이터: 컨슈머의 요청 대기
4. 컨슈머 -> 그룹 코디네이터: 컨슈머 등록 요청 (가장 먼저 요청을 보내는 컨슈머가 컨슈머 그룹의 리더가 됨)
5. 그룹 코디네이터 -> 컨슈머: 요청에 대한 응답
6. 리더 컨슈머: 정해진 컨슈머 파티션 할당 전략에 따라 그룹 내 컨슈머들에게 파티션을 할당한 뒤 그룹 코디네이터에 전달
7. 그룹 코디네이터: 해당 정보 캐시, 각 그룹 내 컨슈머들에게 성공 알림
8. 컨슈머들: 각자 지정된 토픽 파티션으로부터 메시지 가져옴

- 컨슈머들의 변경 감지
  - 컨슈머가 직접 등록/삭제 요청 전송
  - 그룹 코디네이터-컨슈머 간 하트비트 전송

### 스태틱 멤버십

#### 도입 배경
- 컨슈머 재시작을 하면 전체 리밸런싱이 일어남
  - 컨슈머 그룹 내에서는 컨슈머를 구분하기 위한 ID들을 임시로 사용
  - 컨슈머 설정 변경이나 s/w 업데이트 등으로 컨슈머 재시작 시 기존의 동일 컨슈머임에도 새로운 컨슈머로 인식 -> 새로운 ID 부여
  - 컨슈머 그룹의 리밸런싱 발생
- 이런 불필요한 리밸런싱 방어를 위해 스태틱 멤버십 도입 (2.3 버전 ~)

#### 스태틱 멤버십
- 컨슈머마다 인식할 수 있는 ID를 적용해 다시 합류해도 기존 구성원임을 인식할 수 있게 해줌
- 스태틱 멤버십을 적용해도 session.timeout.ms 지정된 시간을 넘어가면 리밸런싱이 일어날 수 있음
