# 가상 면접 사례로 배우는 대규모 시스템 설계 기초

## ch02. 개략적인 규모 측정
> : 보편적으로 통용되는 성능 수치상에서 사고 실험을 행하여 추정치를 계산하는 행위. 
> 어떤 설계가 요구사항에 부합할 것인지 보기 위한 것

- 메모리는 빠르지만 디스크는 아직 느림
- 디스크 탐색은 피하는 것이 좋음
- 단순한 압축 알고리즘은 빠름
- 데이터를 인터넷으로 전송하기 전에 가능하면 압축하라.

## ch03. 시스템 설계 면접 공략법

- 빠르게 대답하는 것은 그닥 메리트가 없다
- 질문을 통해 요구사항과 내 가정을 확인하라
- 면접관과 소통하라
- 가능하다면 여러 해법을 함께 제시하라

## ch04. 처리율 제한 장치의 설계

### 처리율 제한 장치(rate limiter)
- : 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제어하기 위한 장치
- ex) 같은 IP 주소로는 하루에 계정을 3개까지만 만들 수 있다, 사용자는 초당 2회 이상의 새 글을 올릴 수 없다
- 장점
  - DoS 공격에 의한 자원 고갈 방지
  - 비용 절감 (요청을 덜 처리할 수 있으니)
  - 서버 과부하 방지
- 제한 장치의 위치
  - 클라이언트: 클라이언트 요청은 쉽게 위변조가 가능해 통제가 어려울 수 있음
  - API 서버
  - 미들웨어: 클라이언트-API서버 사이에서 API 서버로 가는 요청을 통제
- 어디다 두는 것이 좋을까?
  - 정답은 없다.
  - 사용중인 기술 스택, 설계, 할당 가능한 리소스량에 따라 다름
  - ex: 처리율 제한 장치를 직접 만들기 위한 인력이 없다면 상용 API 게이트웨이를 쓰는 것이 낫다
- 요청이 한도 제한에 걸리면 HTTP 429(too many requests)를 반환하도록 만들 수 있음

### 처리율 제한 알고리즘
> 처리율 제한을 실현하는 알고리즘  
> 자세한 설명은 책을 참고하길 바라며 이 글에서는 생략.

- 토큰 버킷
- 누출 버킷
- 고정 윈도 카운터
- 이동 윈도 로그
- 이동 윈도 카운터

### 분산 환경에서의 처리율 제한 장치
> 여러 대의 서버와 병렬 스레드를 지원하는 시스템을 확장하려면 두 가지 문제를 풀어야함

- 경쟁 조건; race condition
  - 락, 루아 스크립트, Redis - 정렬 집합 등을 통해 해결 가능
- 동기화; synchronization
  - sticky session, 중앙 집중형 데이터 저장소(ex:Redis) 사용 등을 통해 해결 가능

### 더 공부해볼만한 것

- hard / soft 처리율 제한
  - 경성(hard): 요청의 개수는 임계치를 절대 넘을 수 없음
  - 연성(soft): 요청 개수는 잠시동안만 임계치를 넘어설 수 있음
- 다양한 계층에서의 처리율 제한
  - 위 내용은 애플리케이션 계층에서의 처리율 제한임
  - OSI 3계층에서의 Iptables 사용 등 다른 계층에서도 처리율 제한이 가능
- 처리율 제한을 회피하는 방법 (최선의 클라이언트 설계는 무엇인가)
  - 클라이언트 측 캐시를 통해 API 호출 횟수 줄이기
  - 처리율 제한의 임계치를 이해하기 (단기간 많은 메시지 보내지 않도록 하기)
  - 예외/에러 처리하는 코드 도입
  - 재시도 로직을 구현할 때는 충분한 백오프 시간 두기
