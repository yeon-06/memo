# 가상 면접 사례로 배우는 대규모 시스템 설계 기초

## ch05. 안정 해시 설계

- 수평적 규모 확장성을 달성하기 위해서는 요청/데이터를 서버에 **균등**하게 나누는 것이 중요
- 안정 해시는 이 목표를 위해 보편적으로 사용하는 기술

### 해시 키 재배치 문제

3개의 서버에 key 0...5를 배치해보자  
해시 함수를 통해 %3의 결과에 따라 재배치를 한다.

- server0: key0, key3
- server1: key1, key4
- server2: key2, key5

만약 server1에 장애가 발생한다면? 키의 재분배가 필요하다

- server0: key0, key2, key4
- server2: key1, key3, key5

server1에 보관되었던 키를 포함해 많은 키들이 재배치 되었다.  
안정 해시는 이 문제를 효과적으로 해결하기 위한 기술이다.

### 안정 해시; consistent hash

- s는 서버이고, k는 키이다.
- 원 위에 s를 균등 분포 해시 함수를 통해 특정 위치에 배치시킨다
- k 또한 서버처럼 함수를 거쳐 특정 위치에 배치시킨다
- k가 저장된 s찾기: k 위치로부터 시계방향으로 링을 탐색하면 첫 번째로 만나는 s
- s가 추가되거나 제거되면 해당 영역에 존재하던 k만 재배치하면 된다.

![image](https://user-images.githubusercontent.com/53105735/235166366-f7666cd9-ee6b-4594-bd36-b6146d910404.png)

### 가상 노드

안정 해시는 2가지 문제가 있다.
- 파티션의 크기를 균등하게 유지하는 것이 불가하다
  - s와 다른 s의 공간 크기 격차가 클 수 있다
- 키의 균등 분포 달성이 어렵다
  - 특정 s에만 k가 몰려있을 수 있다

이를 해결하기 위해 등장한 것이 가상 노드이다.  

- = virtual node
- 실제 노드 또는 서버를 가리키는 노드
- 하나의 서버는 여러개의 가상 노드를 가질 수 있다
- 가상 노드의 개수를 늘릴수록 키의 분포는 점점 더 균등해진다 (가상 노드 데이터를 저장할 공간이 더 필요하므로 적당한 조정 필요)
