# 가상 면접 사례로 배우는 대규모 시스템 설계 기초

## ch06. 키-값 저장소 설계

## 키-값 저장소

- = key-value store = 키-값 데이터베이스
- 비 관계형 데이터베이스의 일종으로 모든 '값'은 '키'라는 고유 식별자를 갖고 저장된다
- ex: Amazon Dynamo, memcaches, Redis, ...

### 단일 서버 키-값 저장소

- 키-값 쌍 전부를 메모리에 해시 테이블로 저장하면 된다.
- 모든 데이터를 메모리 안에 두는 것은 한계가 존재한다.
  - 개선방법1: 데이터 압축
  - 개선방법2: 자주 쓰이는 데이터만 메모리에 두고, 나머지는 디스크에 저장

### 분산 키-값 저장소 

- = 분산 해시 테이블
- CAP의 요구사항 모두를 충족할 수는 없음 (일반적으로 2가지 만족)

> **CAP**  
> Consistency; 일관성: 모든 클라이언트는 노드 종류에 상관없이 언제나 같은 데이터를 볼 수 있다.  
> Availability; 가용성: 클라이언트는 일부 노드에 장애가 발생해도 항상 응답을 받을 수 있다.  
> Partition Tolerance; 파티션 감내: 네트워크에 파티션이 생겨도 시스템은 계속 동작해야 한다.  
> (Partition; 파티션: 두 노트 사이에 통신 장애가 발생함을 의미)

### 시스템 컴포넌트
> 키-값 저장소 구현에 사용될 핵심 컴포넌트 및 기술

- 데이터 파티션
  - 데이터를 작은 파티션으로 분할해 여러 대 서버에 저장한다
- 데이터 다중화; replication
  - 높은 가용성과 안정성 확보를 위함
  - 데이터를 n개 서버에 비동기적으로 다중화해야 함
- 일관성; consistency
  - 여러 노드에 다중화된 데이터는 적절히 동기화가 되어야 함
  - 정족수 합의 프로토콜 (N=사본 개수, W=쓰기 연산에 대한 정족수, R=읽기 연산에 대한 정족수)
  - ex: R=1, W=N: 빠른 읽기 연산에 최적화된 시스템 / W+R>N: 강한 일관성이 보장된 시스템
- 일관성 불일치 해소
  - 데이터 다중화 시 가용성은 높아지지만 사본 간 일관성은 깨질 가능성도 높아짐
  - 버저닝, 벡터 시계를 통해 해소 가능
- 장애 처리
  - 장애를 감지하고 해소하는 방법
- 시스템 아키텍처 다이어그램
- 쓰기 경로
- 읽기 경로

### 요약

|목표/문제|기술|
|--|--|
|대규모 데이터 저장|안정 해시를 사용해 서버들에 부하 분산|
|읽기 연산에 대한 높은 가용성 보장|데이터를 여러 데이터센터에 다중화|
|쓰기 연산에 대한 높은 가용성 보장|버저닝 및 벡터 시계를 통한 충돌 해소|
|데이터 파티션|안정 해시|
|점진적 규모 확장성|안정 해시|
|다양성|안정 해시|
|조절 가능한 데이터 일관성|정족수 합의; quorum consensus|
|일시적 장애 처리|느슨한 정족수 프로토콜(sloppy quorum)과 단서 후 임시 위탁(hinted handoff)|
|영구적 장애 처리|머클 트리; merkle tree|
|데이터 센터 장애 대응|여러 데이터 센터에 걸쳐 데이터 다중화|
